import Vue from 'vue';
import VueApollo from 'vue-apollo';
import { createApolloClient, restartWebsockets } from 'vue-cli-plugin-apollo/graphql-client';
import store from './store';

// Install the vue plugin
Vue.use(VueApollo);

// MIKE: this was generated by the plugin and i have no idea what it does lol:
// Files URL root
// export const filesRoot = process.env.VUE_APP_FILES_ROOT || httpEndpoint.substr(0, httpEndpoint.indexOf('/graphql'));
// Vue.prototype.$filesRoot = filesRoot;

// Config
const defaultOptions = {
  httpEndpoint: process.env.VUE_APP_GRAPHQL_HTTP,
  wsEndpoint: process.env.VUE_APP_GRAPHQL_WS,
  tokenName: '',
  persisting: false,
  websocketsOnly: false,
  ssr: false,
  getAuth: () => store.state.loggedIn ? `Bearer ${store.state.token}` : '',

  // MIKE: add this in and install apollo-cache-inmemory if the below issue
  // shows up
  // NOTE: see https://github.com/Akryum/vue-apollo/issues/631#issuecomment-498400136
  // cache: new InMemoryCache({
  //   freezeResults: false,
  // }),

  notifyOnNetworkStatusChange: true,
};

export function createClient(options = {}) {
  const { apolloClient, wsClient } = createApolloClient({
    ...defaultOptions,
    ...options,
  });

  // wsClient () documentation:
  // https://github.com/apollographql/subscriptions-transport-ws#subscriptionclient
  // NOTE: you can mutate the client to change its options
  apolloClient.wsClient = wsClient;

  return apolloClient;
}

export function createProvider(apolloClient) {
  const apolloProvider = new VueApollo({
    defaultClient: apolloClient,
    defaultOptions: {
      $query: {
        // NOTE: documentation for "fetchPolicy": https://tinyurl.com/y8swk9py
        fetchPolicy: 'cache-first',
      },
    },
    errorHandler(error) {
      // eslint-disable-next-line no-console
      // MIKE: this logging should be disabled in production
      console.log(error);
    },
  });

  return apolloProvider;
}